<!DOCTYPE html>
<html>
<head>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

<!--      .gm-style .gm-style-iw {-->
<!--        font-size: 21px;-->
<!--      }-->
    .floating-panel {
        position: absolute;
        top: 10px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: left;
        font-family: 'Roboto','sans-serif';
<!--        line-height: 30px;-->
        padding-left: 10px;
      }

      .flat-checkbox-label {
        padding: 5px;
      }

    </style>
    <META http-equiv="content-type" content="text/html; charset=utf-8">
</head>
<body>
<!--<div id="floating-panel">-->
<!--    <input onclick="updateControlPanel();" type=checkbox id="flats" name="flats" value="Flats" checked><label for="flats">Flats</label>-->
<!--    <input onclick="updateControlPanel();" type=checkbox id="houses" name="houses" value="Houses" checked><label for="houses">Houses</label>-->
<!--</div>-->
<div id="map"></div>
<!--<style type="text/css">-->
<!--img[src^='http://www.google.com/mapfiles/marker.png?i=']{-->
<!--  opacity: 0.5-->
<!--}-->
<!--</style>-->
<script>
<!--    var home = new google.maps.LatLng(56.95309568029149,24.1818463802915);-->
    var home = {lat: 56.95309568029149, lng: 24.1818463802915};
    var map;
    var markers;
    var rooms = new Set();
    var types = [];
    var locations = [REPLACE_THAT];
    var main_url = "https://www.google.com/maps/vt/icon/name="

    var house = 'assets/icons/poi/quantum/pinlet/home_pinlet-2-medium.png'
    var heart = 'assets/icons/poi/quantum/pinlet/heart_pinlet-2-medium.png'

    var highlight_red  = '&highlight=ff000000,ea4335,a50e0e'
    var highlight_blue = '&highlight=ffffff,ffffff,4285f4,ffffff'

    var spotlight          = 'assets/icons/spotlight/spotlight_pin_v3-1-small.png'
    var spotlight_shadow   = 'assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png'

    var pinlet          = 'assets/icons/poi/tactile/pinlet_v3-2-medium.png'
    var pinlet_outline  = 'assets/icons/poi/tactile/pinlet_outline_v3-2-medium.png'
    var pinlet_shadow   = 'assets/icons/poi/tactile/pinlet_shadow_v3-2-medium.png'

//https://www.google.com/maps/vt/icon/name=assets/icons/poi/tactile/pinlet_shadow_v3-2-medium.png,assets/icons/poi/tactile/pinlet_outline_v3-2-medium.png,assets/icons/poi/tactile/pinlet_v3-2-medium.png&highlight=ff000000,ffffff,fa507d?scale=1
//https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi-dotless2.png
//https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,ea4335,a50e0e?scale=2

//https://www.google.com/maps/vt/icon/name=assets/icons/poi/tactile/pinlet_shadow_v3-2-medium.png,assets/icons/poi/tactile/pinlet_outline_v3-2-medium.png,assets/icons/poi/tactile/pinlet_v3-2-medium.png,assets/icons/poi/quantum/pinlet/pinlet-2-medium.png&highlight=ff000000,ffffff,4db546,ffffff?scale=1
//https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,ea4335,a50e0e?scale=2
//https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png&highlight=ff000000,ea4335,a50e0e
//
    var icons = {
      flat: {
        name: 'Flat',
        icon: 'https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,ea4335,a50e0e?scale=1'
        //'https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi-dotless2.png'
        //main_url + spotlight_shadow + ',' + spotlight + highlight_red + '?scale=1'
      },
      flats: {
        name: 'Flat',
        icon: 'https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png&highlight=ff000000,ea4335?scale=1'
        //'https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi-dotless2.png'
        //main_url + spotlight_shadow + ',' + spotlight + highlight_red + '?scale=1'
      },
      flat0: {
        icon: 'ico/103.png'
      },
      flat1: {
        icon: 'ico/104.png'
      },
      flat2: {
        icon: 'ico/119.png'
      },
      flat3: {
        icon: 'ico/467.png'
      },
      flat4: {
        icon: 'ico/602.png'
      },
      flat6: {
        icon: 'ico/LTP.png'
      },
      flat7: {
        icon: 'ico/SEM.png'
      },
      flat8: {
        icon: 'ico/NEW.png'
      },
      flat10: {
        icon: 'ico/SPEC.png'
      },
      house: {
        name: 'House',
        icon: 'https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,f0e82e,56890e?scale=1'
        //'https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,ea4335,a50e0e?scale=1'
        //'https://maps.google.com/mapfiles/ms/icons/blue.png'
        //main_url + pinlet_outline + ',' + pinlet_shadow + ',' + pinlet + ',' + house + highlight_blue + '?scale=1'
      },
      default: {
        name: 'Default',
        icon: ''
      }
    };

    function getIcon(location){
        if (location.type === 'flat') {
            var s = new Set();
            location.cnt.forEach(el => s.add(el.type))
            if (s.size === 1) {
                ic = icons['flat'+types.find(t => t.type === s.values().next().value).id]
                if (ic) {
                    return ic.icon
                }
            }
        }
        return icons['default'].icon
    }

    function stringTemplateParser(expression, valueObj) {
        const templateMatcher = /{{\s?([^{}\s]*)\s?}}/g;
        let text = expression.replace(templateMatcher, (substring, value, index) => {
            value = valueObj[value];
            return value;
        });
        return text
    }

    function updateContent(address, cnt) {
        document.infowindow.close();
        str ='{{type}}&nbsp;{{rooms}} &#1082;.&nbsp;{{m2}}m2&nbsp;{{level}}&nbsp;{{price_m2}}/m2&nbsp;<a target="_blank" href="https://{{url}}"><b>{{price}}</b></a>'
        z = '<div class="title full-width">'+address+'</div>';
        cnt.sort((a, b) => a.rooms - b.rooms).filter(el=>!el.hasOwnProperty('enabled') || (el.hasOwnProperty('enabled') && el.enabled)).forEach(el => z += '<div>'+stringTemplateParser(str, el)+'</div>');

        z = '<div class="poi-info-window gm-style">'+z+'</div>'

        document.infowindow = new google.maps.InfoWindow({content: z});
    }


    function setMap(map) {
        markers.forEach(el => el.setMap(map));
    }

    function showAll() {
        setMap(map)
    }

    function hasRoomsNumber(cnt, number) {
        return cnt.filter(el => el.rooms === number+"").length > 0;
    }

    function hasSeries(cnt, number) {
        return cnt.filter(el => el.type === number+"").length > 0;
    }

    function updateState(){
            markers
            .forEach(el => {
                el.cnt.forEach(el => {
                    el.enabled = document.getElementById('flats'+el.rooms).checked && document.getElementById('type'+types.find(t => t.type === el.type).id).checked
                })
                var n = el.cnt.filter(el=> !el.hasOwnProperty('enabled') || (el.hasOwnProperty('enabled') && el.enabled)).length;
                el.setLabel((n > 1)?n+"":" ");
                el.setMap(n===0?null:map)
            }
        );
    }

<!--    function switcher(room, opt){-->
<!--            markers.filter(el => el.type === 'flat' && hasRoomsNumber(el.cnt, room))-->
<!--            .forEach(el => {-->
<!--                el.cnt.filter(el => el.rooms === room).forEach(el => el.enabled = opt)-->
<!--                var n = el.cnt.filter(el=> !el.hasOwnProperty('enabled') || (el.hasOwnProperty('enabled') && el.enabled)).length;-->
<!--                el.setLabel((n > 1)?n+"":" ");-->
<!--                el.setMap(n===0?null:map)-->
<!--            }-->
<!--        );-->
<!--    }-->


<!--    function switcherSeries(series, opt){-->
<!--            markers.filter(el => el.type === 'flat' && hasSeries(el.cnt, series))-->
<!--            .forEach(el => {-->
<!--                el.cnt.filter(el => el.type === series).forEach(el => el.seriesEnabled = opt)-->
<!--                var n = el.cnt.filter(el=> !el.hasOwnProperty('seriesEnabled') || (el.hasOwnProperty('seriesEnabled') && el.seriesEnabled)).length;-->
<!--                el.setLabel((n > 1)?n+"":" ");-->
<!--                el.setMap(n===0?null:map)-->
<!--            }-->
<!--        );-->
<!--    }-->

    function createCheckBox(parent, id, label, handler) {
        var div = document.createElement("div");
        var checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = id;
        checkbox.name = id;
        checkbox.value = id;
        checkbox.checked = true;
        checkbox.className = "flat-checkbox";
        if (handler) {
            checkbox.onclick = handler
        }

        var chckLbl = document.createElement("label");
        chckLbl.htmlFor = checkbox.id;
        chckLbl.innerHTML = label;
        chckLbl.className = "flat-checkbox-label";

        div.appendChild(checkbox);
        div.appendChild(chckLbl);
        parent.appendChild(div);
    }

    function updateFlatsControlPanel(el) {
        document.infowindow.close();
        var flats = el.target;
        //document.getElementById('flats');
        if (flats.checked) {
            rooms.forEach((el, i) => {document.getElementById('flats'+el).checked = true});
        } else {
            rooms.forEach((el, i) => {document.getElementById('flats'+el).checked = false});
            markers.filter(el => el.type === 'flat').forEach(el => el.setMap(null));
        }
        updateState();
    }

    function updateRoomsControlPanel(panel) {
        document.infowindow.close();
<!--        rooms.forEach((el, i) => {switcher(el, document.getElementById('flats'+el).checked)});-->
        updateState();
    }

    function updateSeriesControlPanel(){
        document.infowindow.close();
<!--        types.forEach((el, i) => {switcherSeries(el, document.getElementById('type'+el).checked)});-->
        updateState();
    }

    function updateHousesControlPanel(panel){
        var houses = document.getElementById('houses');
        if (houses.checked) {
            markers.filter(el => el.type === 'house').forEach(el => el.setMap(map));
        } else {
            markers.filter(el => el.type === 'house').forEach(el => el.setMap(null));
        }
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: home,
            mapTypeId: 'hybrid'
        });

<!--var markerIcon = {-->
<!--        url: 'http://image.flaticon.com/icons/svg/252/252025.svg',-->
<!--        scaledSize: new google.maps.Size(80, 80),-->
<!--        origin: new google.maps.Point(0, 0),-->
<!--        anchor: new google.maps.Point(32,65),-->
<!--        labelOrigin:  new google.maps.Point(40,33),-->
<!--      };-->

        uniqueTypes = new Set();
        locations.forEach((location, i) => {
            location.cnt.forEach(el=> {rooms.add(el.rooms); uniqueTypes.add(el.type);});
        });

        let i = 0
        for (let ut of Array.from(uniqueTypes).sort()) {
            types[types.length]={'type': ut, 'id':i};
            i ++;
        }

        markers = locations.map(function(location, i) {
            var m = new google.maps.Marker({
                position: location,
                type: location.type,
                cnt: location.cnt,
                label: {
                    text: location.label+""
                  },
                title: location.title+""
                ,icon: getIcon(location)
            });
            m.addListener("click", function() {updateContent(this.title, this.cnt); document.infowindow.open(map, m);});

            return m;
        });

        showAll(map);

        document.infowindow = new google.maps.InfoWindow({content: ""});

        var typesControlDiv = document.createElement('div');
        typesControlDiv.className = "floating-panel";
        var roomsControlDiv = document.createElement('div');
        roomsControlDiv.className = "floating-panel";
        var housesControlDiv = document.createElement('div');
        housesControlDiv.className = "floating-panel";

        map.controls[google.maps.ControlPosition.TOP_LEFT].push(typesControlDiv);
        map.controls[google.maps.ControlPosition.LEFT_TOP].push(roomsControlDiv);
        map.controls[google.maps.ControlPosition.LEFT_TOP].push(housesControlDiv);
        createCheckBox(housesControlDiv, "houses", "Houses")

        types.forEach(el => createCheckBox(typesControlDiv, "type"+el.id, el.type));

        createCheckBox(roomsControlDiv, "flats", "Flats", updateFlatsControlPanel)
        Array.from(rooms).sort().forEach(el=> createCheckBox(roomsControlDiv, "flats"+el, el, updateRoomsControlPanel));

        google.maps.event.addDomListener(typesControlDiv, 'click', function() {updateSeriesControlPanel(this)});
        google.maps.event.addDomListener(housesControlDiv, 'click', function() {updateHousesControlPanel(this)});

}
</script>

<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCasbDiMWMftbKcSnFrez-SF-YCechHSLA&callback=initMap">
</script>
</body>
</html>