<!DOCTYPE html>
<html>
<head>
    <META http-equiv="content-type" content="text/html; charset=utf-8">
    <style>
      #map {
        height: 100%;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

    .floating-panel {
        position: absolute;
        top: 10px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: left;
        font-family: 'Roboto','sans-serif';
        padding-left: 10px;
        margin: 10px;
        opacity: 60%;
      }

    .floating-panel:hover {
        opacity: 100%;
    }

      .flat-checkbox-label {
        padding: 5px;
      }


    </style>
</head>
<body>
<!--<div id="floating-panel">-->
<!--    <input onclick="updateControlPanel();" type=checkbox id="flats" name="flats" value="Flats" checked><label for="flats">Flats</label>-->
<!--    <input onclick="updateControlPanel();" type=checkbox id="houses" name="houses" value="Houses" checked><label for="houses">Houses</label>-->
<!--</div>-->
<div id="map"></div>
<!--<style type="text/css">-->
<!--img[src^='http://www.google.com/mapfiles/marker.png?i=']{-->
<!--  opacity: 0.5-->
<!--}-->
<!--</style>-->
<script>
    let $$ = (tag) => {
        let _o = document.createElement(tag);
        _o.set = (property, value) => {_o[property] = value; return _o}
        return _o;
    };
    let $ = (id) => document.getElementById(id);

    var home = {lat: 56.95309568029149, lng: 24.1818463802915};
    var map;
    var markers;
    var rooms = new Set();
    var types = [];
    var price = new Set();
    var locations = [REPLACE_THAT];
    var main_url = "https://www.google.com/maps/vt/icon/name="

    var house = 'assets/icons/poi/quantum/pinlet/home_pinlet-2-medium.png'
    var heart = 'assets/icons/poi/quantum/pinlet/heart_pinlet-2-medium.png'

    var highlight_red  = '&highlight=ff000000,ea4335,a50e0e'
    var highlight_blue = '&highlight=ffffff,ffffff,4285f4,ffffff'

    var spotlight          = 'assets/icons/spotlight/spotlight_pin_v3-1-small.png'
    var spotlight_shadow   = 'assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png'

    var pinlet          = 'assets/icons/poi/tactile/pinlet_v3-2-medium.png'
    var pinlet_outline  = 'assets/icons/poi/tactile/pinlet_outline_v3-2-medium.png'
    var pinlet_shadow   = 'assets/icons/poi/tactile/pinlet_shadow_v3-2-medium.png'

//https://www.google.com/maps/vt/icon/name=assets/icons/poi/tactile/pinlet_shadow_v3-2-medium.png,assets/icons/poi/tactile/pinlet_outline_v3-2-medium.png,assets/icons/poi/tactile/pinlet_v3-2-medium.png&highlight=ff000000,ffffff,fa507d?scale=1
//https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi-dotless2.png
//https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,ea4335,a50e0e?scale=2

//https://www.google.com/maps/vt/icon/name=assets/icons/poi/tactile/pinlet_shadow_v3-2-medium.png,assets/icons/poi/tactile/pinlet_outline_v3-2-medium.png,assets/icons/poi/tactile/pinlet_v3-2-medium.png,assets/icons/poi/quantum/pinlet/pinlet-2-medium.png&highlight=ff000000,ffffff,4db546,ffffff?scale=1
//https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,ea4335,a50e0e?scale=2
//https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png&highlight=ff000000,ea4335,a50e0e
//
    var icons = {
      flat: {
        name: 'Flat',
        icon: 'https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,ea4335,a50e0e?scale=1'
        //'https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi-dotless2.png'
        //main_url + spotlight_shadow + ',' + spotlight + highlight_red + '?scale=1'
      },
      flats: {
        name: 'Flat',
        icon: 'https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png&highlight=ff000000,ea4335?scale=1'
        //'https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi-dotless2.png'
        //main_url + spotlight_shadow + ',' + spotlight + highlight_red + '?scale=1'
      },
      flat0: {
        icon: 'ico/103.png'
      },
      flat1: {
        icon: 'ico/104.png'
      },
      flat2: {
        icon: 'ico/119.png'
      },
      flat3: {
        icon: 'ico/467.png'
      },
      flat4: {
        icon: 'ico/602.png'
      },
<!--      flat5: {-->
<!--        icon: 'https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,f0e82e,56890e?scale=1'-->
<!--      },-->
      flat6: {
        icon: 'ico/LTP.png'
      },
      flat7: {
        icon: 'ico/SEM.png'
      },
      flat8: {
        icon: 'ico/NEW.png'
      },
      flat10: {
        icon: 'ico/SPEC.png'
      },
<!--      flat11: {-->
<!--        icon: 'https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,f26f63,a50e0e?scale=1'-->
<!--      },-->
      house: {
        name: 'House',
        icon: 'https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,f0e82e,56890e?scale=1'
        //'https://www.google.com/maps/vt/icon/name=assets/icons/spotlight/spotlight_pin_v3_shadow-1-small.png,assets/icons/spotlight/spotlight_pin_v3-1-small.png,assets/icons/spotlight/spotlight_pin_v3_dot-1-small.png&highlight=ff000000,ea4335,a50e0e?scale=1'
        //'https://maps.google.com/mapfiles/ms/icons/blue.png'
        //main_url + pinlet_outline + ',' + pinlet_shadow + ',' + pinlet + ',' + house + highlight_blue + '?scale=1'
      },
      default: {
        name: 'Default',
        icon: ''
      }
    };

    function getIcon(location){
        if (location.type === 'flat') {
            var s = new Set();
            location.cnt.forEach(el => s.add(el.type))
            if (s.size === 1) {
                ic = icons['flat'+types.find(t => t.type === s.values().next().value).id]
                if (ic) {
                    return ic.icon
                }
            }
        }
        return icons['default'].icon
    }

    function stringTemplateParser(expression, valueObj) {
        const templateMatcher = /{{\s?([^{}\s]*)\s?}}/g;
        let text = expression.replace(templateMatcher, (substring, value, index) => {
            value = valueObj[value];
            return value;
        });
        return text
    }

    let isEnabled = (el) => {return !el.hasOwnProperty('enabled') || (el.hasOwnProperty('enabled') && el.enabled)}

    function updateContent(address, cnt) {
        document.infowindow.close();
        let str1 = '<td style="text-align:right">{{date}}</td><td style="text-align:right">{{type}}</td><td style="text-align:right">'
        let str2 = '</td><td style="text-align:right">{{m2}}m2</td><td style="text-align:right">{{level}}</td><td style="text-align:right">{{price_m2}}/m2</td><td style="text-align:right"><a target="_blank" href="https://{{url}}"><b>{{price}}</b></a></td>'
        let z = '<div class="poi-info-window gm-style"><div class="title full-width">'+address+'</div><table>';
        cnt.sort((a, b) => a.rooms - b.rooms)
            .filter(el => isEnabled(el))
            .forEach(el => {
                let template = str1 + (el.hasOwnProperty('rooms') && el['rooms']?'{{rooms}} &#1082;.':"") + str2;
                z += '<tr>'+stringTemplateParser(template, el)+'</tr>'
        });

        z += '</table></div>'

        document.infowindow = new google.maps.InfoWindow({content: z});
    }

    let ranges = {
        range1: {
            from:   0,
            to:     50000
        },
        range2: {
            from:   50000,
            to:     100000
        },
        range3: {
            from:   100000,
            to:     150000
        },
        range4: {
            from:   150000,
            to:     200000
        },
        range5: {
            from:   200000,
            to:     300000
        },
        range6: {
            from:   300000,
            to:     500000
        },
        range7: {
            from:   500000,
            to:     Number.MAX_SAFE_INTEGER
        }
    };

    let identifyRangeKey = (p) => {
        let keys = Object.keys(ranges);
        for(idx in keys) {
            let rangeName = keys[idx];
            if(ranges[rangeName].from < p && p <= ranges[rangeName].to) {
                return rangeName;
            }
       }
       return keys[keys.length-1];
    }

    let extractPrice = (price) => {return parseInt(price.replace('â‚¬', '').replace(',', ''))}

    let pricesPerRange = (range) => {
        let calculateItems = (total, el) => {
            return total + el.cnt.filter(el=> {let n = extractPrice(el.price); let r = ranges[range]; return n >= r.from && n < r.to}).length;
        }

        return markers.reduce(calculateItems, 0);
    }


    let buildFlatId = (key) => `flats${key}`;
    let buildTypeId = (key) => `type${key}`;

    let updateState = () => {
        document.infowindow.close();
        markers.forEach(el => {
            el.cnt.forEach(el => {
                el.enabled = $(buildFlatId(el.rooms)).checked
                    && $(`type${types.find(t => t.type === el.type).id}`).checked
                    && $(identifyRangeKey(extractPrice(el.price))).checked;
            })
            var n = el.cnt.filter(el => isEnabled(el)).length;
            el.setLabel((n > 1)?n+"":" ");
            el.setMap(n===0?null:map)
        });
    }

    function createCheckBox(parent, id, label, handler) {
        let div = $$("div");
        let checkbox = $$("input").set('type', 'checkbox').set('id', id).set('name', id).set('value', id).set('checked', true).set('className', 'flat-checkbox').set('onclick', handler)
        let chckLbl = $$("label").set('className', "flat-checkbox-label").set('htmlFor', checkbox.id).set('innerHTML', label);

        div.appendChild(checkbox);
        div.appendChild(chckLbl);
        parent.appendChild(div);
    }

    function updateFlatsControlPanel(el) {
        document.infowindow.close();
        var flats = el.target;
        if (flats.checked) {
            rooms.forEach((el, i) => {$('flats'+el).checked = true});
        } else {
            rooms.forEach((el, i) => {$('flats'+el).checked = false});
            markers.filter(el => el.type === 'flat').forEach(el => el.setMap(null));
        }
        updateState();
    }

    function updateHousesControlPanel(panel){
        var houses = $('houses');
        if (houses.checked) {
            markers.filter(el => el.type === 'house').forEach(el => el.setMap(map));
        } else {
            markers.filter(el => el.type === 'house').forEach(el => el.setMap(null));
        }
    }

    function initMap() {
        map = new google.maps.Map($('map'), {
            zoom: 15,
            center: home,
            mapTypeId: 'hybrid'
        });

        let uniqueTypes = new Set();
        locations.forEach((location, i) => {
            location.cnt.forEach(el=> {
                rooms.add(el.rooms);
                uniqueTypes.add(el.type);
            });
        });

        let i = 0
        for (let ut of Array.from(uniqueTypes).sort()) {
            types[types.length]={'type': ut, 'id':i};
            i ++;
        }

        markers = locations.map(function(location, i) {
            var m = new google.maps.Marker({
                mapTypeControl: true,
                position: location,
                type: location.type,
                cnt: location.cnt,
                label: {
                    text: location.label+""
                  },
                title: location.title+""
                ,icon: getIcon(location)
            });
            m.addListener("click", function () {updateContent(this.title, this.cnt); document.infowindow.open(map, m);});
            return m;
        });

<!--        if (localStorage.getItem('myItem')) {-->
<!--            myValue = localStorage.getItem('myItem');-->
<!--        }-->

        markers.forEach(el => el.setMap(map));

        document.infowindow = new google.maps.InfoWindow({content: ""});


        let typesControlDiv = $$('div').set('className', "floating-panel");
        let roomsControlDiv = $$('div').set('className', "floating-panel");
        let housesControlDiv = $$('div').set('className', "floating-panel");
        let pricesControlDiv = $$('div').set('className', "floating-panel");
        createCheckBox(housesControlDiv, "houses", "Houses", updateState)

        map.controls[google.maps.ControlPosition.TOP_LEFT].push(roomsControlDiv);
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(housesControlDiv);
        map.controls[google.maps.ControlPosition.LEFT_TOP].push(typesControlDiv);
        map.controls[google.maps.ControlPosition.LEFT_TOP].push(pricesControlDiv);

        types.forEach(el => createCheckBox(typesControlDiv, buildTypeId(el.id), el.type));
        google.maps.event.addDomListener(typesControlDiv, 'click', updateState);

        createCheckBox(roomsControlDiv, "flats", "Flats", updateFlatsControlPanel)
        Array.from(rooms).sort().forEach(el=> createCheckBox(roomsControlDiv, buildFlatId(el), el, updateState));

        createCheckBox(pricesControlDiv, "range1", `<div style="display:inline-block;width:35px"><50k</div><div style="display:inline;">(${pricesPerRange('range1')})</div>`, updateState);
        createCheckBox(pricesControlDiv, "range2", `<div style="display:inline-block;width:35px"><100k</div><div style="display:inline">(${pricesPerRange('range2')})</div>`, updateState);
        createCheckBox(pricesControlDiv, "range3", `<div style="display:inline-block;width:35px"><150k</div><div style="display:inline">(${pricesPerRange('range3')})</div>`, updateState);
        createCheckBox(pricesControlDiv, "range4", `<div style="display:inline-block;width:35px"><200k</div><div style="display:inline">(${pricesPerRange('range4')})</div>`, updateState);
        createCheckBox(pricesControlDiv, "range5", `<div style="display:inline-block;width:35px"><300k</div><div style="display:inline">(${pricesPerRange('range5')})</div>`, updateState);
        createCheckBox(pricesControlDiv, "range6", `<div style="display:inline-block;width:35px"><500k</div><div style="display:inline">(${pricesPerRange('range6')})</div>`, updateState);
        createCheckBox(pricesControlDiv, "range7", `<div style="display:inline-block;width:35px">>500k</div><div style="display:inline">(${pricesPerRange('range7')})</div>`, updateState);

<!--        setTimeout(searchForPopUp, 6000);-->

    }

    function removePopUp(map) {
        if (map && map.childNodes) {
            for(c in map.childNodes) {
                let child = map.childNodes[c];
                if (child && child.innerText.includes("This page can't load Google Maps correctly")) {
                    map.removeChild(child);
                    return;
                }
            }
<!--//For development purposes only-->
        }
    }

    function searchForPopUp() {
        let m = $('map');
        removePopUp(m);
        processElement(m, m);
    }

    function processElement(parent, el) {
        if (el.style && el.style.cssText.includes('background-color: rgba(0, 0, 0, 0.5)')) {
            parent.removeChild(el)
            return;
        }

        if (el.childNodes) {
<!--            var childs = Array.from(el.childNodes);-->
            for(c in el.childNodes) {
                processElement(el, el.childNodes[c]);
            }
        }
    }

function first() {
    localStorage.setItem('myItem', "something you want to store");
}

function second() {
    myValue = null;
    if (localStorage.getItem('myItem')) {
        myValue = localStorage.getItem('myItem');
    }
}
</script>

<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCasbDiMWMftbKcSnFrez-SF-YCechHSLA&callback=initMap">
</script>
</body>
</html>